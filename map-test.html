<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>地圖測試</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // 檢查庫是否正確載入
    window.addEventListener('load', function() {
      if (typeof L === 'undefined') {
        console.error('Leaflet 未載入');
        alert('Leaflet 地圖庫載入失敗');
        return;
      }
      console.log('Leaflet 地圖庫載入成功');
    });
  </script>
  <style>
    body {
      margin: 0;
      padding: 20px;
      font-family: Arial, sans-serif;
    }
    #map {
      width: 100%;
      height: 500px;
      border: 1px solid #ccc;
      border-radius: 8px;
    }
    .controls {
      margin: 20px 0;
    }
    button {
      padding: 10px 20px;
      margin: 5px;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background: #0056b3;
    }
  </style>
</head>
<body>
  <h1>地圖測試頁面</h1>
  <div class="controls">
    <button onclick="loadMap('D1')">載入 D1 地圖</button>
    <button onclick="loadMap('D2')">載入 D2 地圖</button>
    <button onclick="loadMap('D3')">載入 D3 地圖</button>
    <button onclick="loadMap('D4')">載入 D4 地圖</button>
  </div>
  <div id="map"></div>

  <script>
    let map = null;
    let currentMarkers = [];
    let currentPolylines = [];

    function loadMap(day) {
      // 檢查庫是否載入
      if (typeof L === 'undefined') {
        alert('Leaflet 地圖庫未載入，請重新整理頁面');
        return;
      }

      if (!map) {
        map = L.map('map', {
          center: [23.5, 121],
          zoom: 8
        });
        
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors',
          maxZoom: 19
        }).addTo(map);
      }

      // 清除舊的標記和路線
      currentMarkers.forEach(marker => map.removeLayer(marker));
      currentPolylines.forEach(line => map.removeLayer(line));
      currentMarkers = [];
      currentPolylines = [];

      // 使用簡單的標記點方法
      const routeData = getRouteData(day);
      if (routeData) {
        try {
          console.log(`載入路線數據 (${day})`);
          
          // 添加標記點
          routeData.points.forEach(point => {
            const marker = L.marker([point.lat, point.lon])
              .bindPopup(point.name)
              .addTo(map);
            currentMarkers.push(marker);
          });
          
          // 添加路線
          const route = routeData.points.map(p => [p.lat, p.lon]);
          const polyline = L.polyline(route, { 
            color: 'red', 
            weight: 3 
          }).addTo(map);
          currentPolylines.push(polyline);
          
          // 縮放到路線範圍，並擴大顯示區域
          const bounds = polyline.getBounds();
          map.fitBounds(bounds.pad(0.4)); // 增加邊界範圍
          
          console.log(`路線載入完成 (${day})`);
        } catch(e) {
          console.error(`路線載入失敗 (${day}):`, e);
          alert(`路線載入失敗 (${day}): ${e.message || '未知錯誤'}`);
        }
      } else {
        console.error(`找不到 ${day} 的路線數據`);
        alert(`找不到 ${day} 的路線數據`);
      }
    }

    // 路線數據函數
    function getRouteData(day) {
      const routeData = {
        'D1': {
          points: [
            { lat: 24.372681, lon: 121.344573, name: '勝光登山口' },
            { lat: 24.374728, lon: 121.352304, name: '大水池登山口' },
            { lat: 24.372469, lon: 121.365729, name: '5.3K岔路口' },
            { lat: 24.369071, lon: 121.383761, name: '松風嶺8.0K' },
            { lat: 24.370011, lon: 121.397066, name: '木杆鞍部' },
            { lat: 24.370193, lon: 121.397087, name: '南湖溪山屋' },
            { lat: 24.34689, lon: 121.40653, name: '香菇寮營地' }
          ]
        },
        'D2': {
          points: [
            { lat: 24.34689, lon: 121.40653, name: '香菇寮營地' },
            { lat: 24.33553, lon: 121.41827, name: '中央尖溪山屋' },
            { lat: 24.308619, lon: 121.421371, name: '中央尖鞍部' },
            { lat: 24.31023, lon: 121.41621, name: '中央尖山' },
            { lat: 24.308566, lon: 121.412555, name: '天空營地' }
          ]
        },
        'D3': {
          points: [
            { lat: 24.3400, lon: 121.5500, name: '天空營地' },
            { lat: 24.3380, lon: 121.5600, name: '中央尖山西峰' },
            { lat: 24.3350, lon: 121.5750, name: '甘薯峰' },
            { lat: 24.3320, lon: 121.5850, name: '甘薯南峰營地' },
            { lat: 24.3300, lon: 121.5950, name: '鬼門關峰' },
            { lat: 24.3280, lon: 121.6050, name: '無明水池' }
          ]
        },
        'D4': {
          points: [
            { lat: 24.3280, lon: 121.6050, name: '無明水池' },
            { lat: 24.3250, lon: 121.6150, name: '無明山' },
            { lat: 24.3220, lon: 121.6250, name: '鈴鳴山' },
            { lat: 24.3200, lon: 121.6350, name: '鈴鳴東鞍營地' },
            { lat: 24.3180, lon: 121.6450, name: '人待山' }
          ]
        }
      };
      return routeData[day] || null;
    }

    // 頁面載入完成後自動載入D1地圖
    window.addEventListener('load', function() {
      setTimeout(() => loadMap('D1'), 1000);
    });
  </script>
</body>
</html>
